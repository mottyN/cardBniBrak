<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>לוח כרטיסים - בני ברק</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1500&q=80') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }

        header {
            background-color: rgba(255, 255, 255, 0.85);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            color: #ff5722;
        }

        main {
            max-width: 700px;
            margin: auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        input,
        button {
            margin: 0.5rem 0;
            padding: 0.75rem;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        button {
            background-color: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #e67e22;
        }

        .card {
            background-color: #fff9f1;
            padding: 1rem;
            border: 1px solid #f0cfa3;
            margin-bottom: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .hide {
            display: none;
        }

        .section-title {
            margin-top: 2rem;
            font-size: 1.4rem;
            color: #ff7043;
            border-bottom: 2px solid #ffc107;
            display: inline-block;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";


        const firebaseConfig = {
            apiKey: "AIzaSyAtXUnR_DIDITUtHg5BxwrMIJlNUYd8G3U",
            authDomain: "card-bni-brek.firebaseapp.com",
            projectId: "card-bni-brek",
            storageBucket: "card-bni-brek.firebasestorage.app",
            messagingSenderId: "583998866777",
            appId: "1:583998866777:web:8e7a3c414879b892d37848",
            measurementId: "G-NQC5HC90L7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const userNameSpan = document.getElementById('userName');
        const loginPrompt = document.getElementById('loginPrompt');
        const postSection = document.getElementById('postSection');
        let currentUserEmail = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                loginPrompt.classList.add('hide');
                postSection.classList.remove('hide');
                userNameSpan.textContent = user.displayName;
                currentUserEmail = user.email;
            } else {
                loginPrompt.classList.remove('hide');
                postSection.classList.add('hide');
                currentUserEmail = null;
            }
        });

        window.signInWithGoogle = async function () {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        }

        window.signOut = async function () {
            await signOut(auth);
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserEmail) return;
            const post = {
                eventName: document.getElementById('eventName').value,
                eventCode: document.getElementById('eventCode').value,
                ticketCount: document.getElementById('ticketCount').value,
                contactName: document.getElementById('contactName').value,
                contactPhone: document.getElementById('contactPhone').value,
                email: currentUserEmail,
                createdAt: new Date()
            };
            await addDoc(collection(db, 'posts'), post);
            alert('המודעה פורסמה בהצלחה!');
            document.getElementById('postForm').reset();
            loadPosts();
        });

        document.getElementById('searchInput').addEventListener('input', loadPosts);

        async function loadPosts() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            const container = document.getElementById('posts');
            container.innerHTML = '';
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (
                    data.eventName.toLowerCase().includes(searchValue) ||
                    data.eventCode.toLowerCase().includes(searchValue)
                ) {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
            <b>אירוע:</b> ${data.eventName}<br>
            <b>קוד:</b> ${data.eventCode}<br>
            <b>כרטיסים:</b> ${data.ticketCount}<br>
            <b>שם ליצירת קשר:</b> ${data.contactName}<br>
            <b>טלפון / מייל:</b> ${data.contactPhone}<br>
          `;
                    if (data.email === currentUserEmail) {
                        const btn = document.createElement('button');
                        btn.textContent = '🗑️ מחק';
                        btn.onclick = async () => {
                            await deleteDoc(doc(db, 'posts', docSnap.id));
                            loadPosts();
                        };
                        div.appendChild(btn);
                    }
                    container.appendChild(div);
                }
            });
        }

        loadPosts();
    </script>
</head>

<body>
    <header>
        <h1>לוח החלפת כרטיסים - בני ברק</h1>
    </header>
    <main>
        <div id="userDiv">
            <div id="postSection" class="hide">
                <p>שלום <span id="userName"></span> | <button onclick="signOut()">התנתק</button></p>
                <h2 class="section-title">📢 פרסם מודעה חדשה</h2>
                <form id="postForm">
                    <input type="text" id="eventName" placeholder="שם האירוע" required>
                    <input type="text" id="eventCode" placeholder="קוד האירוע" required>
                    <input type="number" id="ticketCount" placeholder="מספר כרטיסים" required>
                    <input type="text" id="contactName" placeholder="שם ליצירת קשר" required>
                    <input type="text" id="contactPhone" placeholder="טלפון או מייל" required>
                    <button type="submit">פרסם</button>
                </form>
            </div>
            <div id="loginPrompt">
                <button onclick="signInWithGoogle()">🔐 התחבר עם גוגל כדי לפרסם מודעה</button>
            </div>
        </div>

        <h2 class="section-title">🔍 חיפוש מודעות</h2>
        <input type="text" id="searchInput" placeholder="הקלד שם אירוע או קוד">

        <h2 class="section-title">מודעות קיימות</h2>
        <div id="posts"></div>
    </main>
</body>

</html>